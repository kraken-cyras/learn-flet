name: Build Flet Android APK

on:
  push:
    branches: ["main", "master"]
  workflow_dispatch:
  release:
    types: [published]

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------
      # CHECKOUT SOURCE
      # -----------------------------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # -----------------------------------------
      # INSTALL BUILD DEPENDENCIES FOR BUILDOZER
      # -----------------------------------------
      - name: Install System Dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            python3-pip python3-setuptools python3-venv \
            git zip unzip ccache openjdk-17-jdk \
            autoconf automake libtool pkg-config \
            zlib1g-dev libncurses5 libncurses5-dev libffi-dev libssl-dev \
            libsqlite3-dev libjpeg-dev libfreetype6-dev

      # -----------------------------------------
      # PYTHON DEPENDENCIES
      # -----------------------------------------
      - name: Install Python Dependencies
        run: |
          python3 -m pip install --upgrade pip wheel setuptools
          pip install buildozer cython flet
          if [ -f requirements-build.txt ]; then pip install -r requirements-build.txt; fi

      # -----------------------------------------
      # CACHE BUILDOZER OUTPUT FOR FASTER BUILDS
      # -----------------------------------------
      - name: Cache Buildozer Directory
        uses: actions/cache@v3
        id: buildozer-cache
        with:
          path: .buildozer
          key: buildozer-${{ hashFiles('buildozer.spec') }}
          restore-keys: |
            buildozer-

      # -----------------------------------------
      # BUILD APK VIA BUILDOZER (CORRECT METHOD)
      # -----------------------------------------
      - name: Build Debug APK
        run: buildozer android debug

      # -----------------------------------------
      # FIND APK
      # -----------------------------------------
      - name: Locate APK
        id: find_apk
        run: |
          APK_FILE=$(ls bin/*.apk | head -n 1 || true)
          if [ -z "$APK_FILE" ]; then
            echo "âŒ No APK found in bin/"
            exit 1
          fi
          echo "apk_path=$APK_FILE" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Found APK: $APK_FILE"

      # -----------------------------------------
      # UPLOAD APK ARTIFACT
      # -----------------------------------------
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: clc-kenya-flet-apk
          path: ${{ steps.find_apk.outputs.apk_path }}
          retention-days: 14
