name: Build Flet Android APK

on:
  push:
    branches: ["main", "master"]
    tags:
      - "*"
  workflow_dispatch:
  release:
    types: [published]

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Cache PIP
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: pip-${{ hashFiles('requirements.txt') }}
        restore-keys: pip-

    - name: Install Python Dependencies
      run: |
        python3 -m pip install --upgrade pip wheel setuptools
        pip install --upgrade flet buildozer cython pyinstaller
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Cache Android SDK
      uses: actions/cache@v3
      id: android-cache
      with:
        path: ~/android-sdk
        key: android-sdk-cache

    - name: Install Android SDK
      if: steps.android-cache.outputs.cache-hit != 'true'
      run: |
        export ANDROID_SDK_ROOT=$HOME/android-sdk
        mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O tools.zip
        unzip -q tools.zip
        rm tools.zip
        mv cmdline-tools $ANDROID_SDK_ROOT/cmdline-tools/latest
        export PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH
        yes | sdkmanager --licenses
        sdkmanager "platform-tools" \
                   "platforms;android-33" \
                   "build-tools;33.0.2" \
                   "ndk;25.2.9519653"

    - name: Set Android SDK environment paths
      run: |
        echo "ANDROID_SDK_ROOT=$HOME/android-sdk" >> $GITHUB_ENV
        echo "$HOME/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$HOME/android-sdk/platform-tools" >> $GITHUB_PATH

    - name: Build APK
      run: |
        flet build apk --verbose


    - name: Verify APK
      run: |
        APK_FILE=$(find build -name "*.apk" | head -1)
        if [ -z "$APK_FILE" ]; then
          echo "❌ APK not found!"
          find build -type f | head -50
          exit 1
        fi
        echo "✅ APK found at: $APK_FILE"
        ls -lh "$APK_FILE"

    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Android-APK
        path: build/**/*.apk
        retention-days: 14
