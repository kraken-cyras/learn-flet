name: Build Android APK

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]
  release:
    types: [published]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.10'
  JAVA_VERSION: '17'
  GRADLE_USER_HOME: ${{ github.workspace }}/.gradle

jobs:
  build-android:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: |
            **/requirements.txt
            **/requirements-dev.txt

      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          # Add build tools if needed
          pip install buildozer cython

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'

      - name: Cache Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ${{ env.GRADLE_USER_HOME }}
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Configure build environment
        run: |
          mkdir -p build/apk
          echo "BUILD_NUMBER=${{ github.run_number }}" >> $GITHUB_ENV
          echo "GIT_COMMIT=${GITHUB_SHA::8}" >> $GITHUB_ENV

      - name: Build APK
        run: |
          python build_android.py \
            --build-number ${{ env.BUILD_NUMBER }} \
            --commit-id ${{ env.GIT_COMMIT }}
        env:
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}

      - name: Generate APK metadata
        id: apk-info
        run: |
          if [ -f build/apk/*.apk ]; then
            APK_FILE=$(ls -1 build/apk/*.apk | head -1)
            APK_NAME=$(basename "$APK_FILE")
            APK_SIZE=$(du -h "$APK_FILE" | cut -f1)
            APK_HASH=$(sha256sum "$APK_FILE" | cut -d' ' -f1)
            
            echo "apk_file=$APK_FILE" >> $GITHUB_OUTPUT
            echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
            echo "apk_size=$APK_SIZE" >> $GITHUB_OUTPUT
            echo "apk_hash=$APK_HASH" >> $GITHUB_OUTPUT
            
            echo "âœ… APK Built Successfully"
            echo "  Name: $APK_NAME"
            echo "  Size: $APK_SIZE"
            echo "  Hash: $APK_HASH"
          else
            echo "âŒ APK build failed: No APK file found"
            exit 1
          fi

      - name: Upload APK artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: clc-kenya-apk-${{ env.GIT_COMMIT }}
          path: build/apk/*.apk
          retention-days: 30
          if-no-files-found: error

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ env.GIT_COMMIT }}
          path: build/logs/
          retention-days: 7
          if-no-files-found: ignore

      - name: Create Release Notes
        if: github.event_name == 'release'
        id: release-notes
        run: |
          cat > release_notes.md << 'EOF'
          # CLC Kenya Android App
          
          ## Build Information
          - **Version**: ${{ github.event.release.tag_name }}
          - **Build Number**: ${{ env.BUILD_NUMBER }}
          - **Commit**: ${{ env.GIT_COMMIT }}
          - **APK Name**: ${{ steps.apk-info.outputs.apk_name }}
          - **APK Size**: ${{ steps.apk-info.outputs.apk_size }}
          - **SHA256**: `${{ steps.apk-info.outputs.apk_hash }}`
          - **Build Date**: ${{ github.event.release.published_at }}
          
          ## Installation
          Download the APK and install on your Android device.
          
          ## Changes
          ${{ github.event.release.body }}
          EOF

      - name: Upload to Release
        if: github.event_name == 'release' && success()
        uses: softprops/action-gh-release@v1
        with:
          files: build/apk/*.apk
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify on success
        if: success()
        run: |
          echo "ðŸŽ‰ Build completed successfully!"
          echo "APK: ${{ steps.apk-info.outputs.apk_name }}"
          echo "Size: ${{ steps.apk-info.outputs.apk_size }}"

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Build failed!"
          exit 1

  test:
    runs-on: ubuntu-latest
    needs: build-android
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run tests
        run: |
          pytest --cov=. --cov-report=xml

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: unittests
