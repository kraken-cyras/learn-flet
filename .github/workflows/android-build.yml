name: Build Flet Android APK

on:
  push:
    branches: ["main", "master"]
    tags: ["*"]
  workflow_dispatch:
  release:
    types: [published]

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:

      # -----------------------
      # CHECKOUT PROJECT
      # -----------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # -----------------------
      # INSTALL SYSTEM DEPENDENCIES
      # -----------------------
      - name: Install Build Dependencies
        run: |
          sudo apt update -qq
          sudo apt install -qqy --no-install-recommends \
            python3-pip python3-setuptools python3-venv \
            git zip unzip ccache openjdk-17-jdk \
            autoconf automake libtool pkg-config \
            zlib1g-dev libncurses-dev libffi-dev libssl-dev \
            wget curl

      # -----------------------
      # INSTALL ANDROID SDK & NDK
      # -----------------------
      - name: Install Android SDK & NDK
        run: |
          export ANDROID_SDK_ROOT=$HOME/android-sdk
          mkdir -p $ANDROID_SDK_ROOT/cmdline-tools

          cd $ANDROID_SDK_ROOT/cmdline-tools
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O sdk.zip
          unzip -qq sdk.zip -d latest
          rm sdk.zip

          export PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH

          yes | sdkmanager --licenses
          sdkmanager "platform-tools" \
                     "platforms;android-33" \
                     "build-tools;33.0.2" \
                     "ndk;25.2.9519653"
          
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH" >> $GITHUB_ENV

      # -----------------------
      # PYTHON DEPENDENCIES
      # -----------------------
      - name: Install Python Dependencies
        run: |
          pip install --upgrade pip wheel setuptools
          pip install flet
          pip install buildozer cython
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # -----------------------
      # BUILD APK via Flet Pack
      # -----------------------
      - name: Build APK using Flet
        env:
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
        run: |
          echo "Using Android SDK: $ANDROID_SDK_ROOT"
          flet pack android --verbose

      # -----------------------
      # VERIFY APK
      # -----------------------
      - name: Verify APK
        run: |
          APK_FILE=$(find build -name "*.apk" | head -1)
          if [ -z "$APK_FILE" ]; then
            echo "❌ No APK found!"
            find build -type f | head -20
            exit 1
          fi
          echo "✅ APK found: $APK_FILE"
          ls -lh "$APK_FILE"

      # -----------------------
      # UPLOAD ARTIFACT
      # -----------------------
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: clc-kenya-android-apk
          path: build/**/*.apk
          retention-days: 14
